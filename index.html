<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>2FA 验证器</title>
  <link rel="stylesheet" href="index.css">
</head>
<body>
  <div class="app">
    <!-- 顶部导航 -->
    <header class="header">
      <div class="header-left">
        <div class="logo">Google 2FA</div>
        <nav class="nav">
          <button class="nav-btn active" data-view="home">验证码</button>
          <button class="nav-btn" data-view="manage">管理</button>
          <button class="nav-btn" data-view="migration">迁移</button>
        </nav>
      </div>
      <div class="header-right">
        <button class="icon-btn" id="settingsBtn" title="设置" aria-label="打开设置">
          <svg class="icon settings-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="1.9"></circle> <path d="M3.66122 10.6392C4.13377 10.9361 4.43782 11.4419 4.43782 11.9999C4.43781 12.558 4.13376 13.0638 3.66122 13.3607C3.33966 13.5627 3.13248 13.7242 2.98508 13.9163C2.66217 14.3372 2.51966 14.869 2.5889 15.3949C2.64082 15.7893 2.87379 16.1928 3.33973 16.9999C3.80568 17.8069 4.03865 18.2104 4.35426 18.4526C4.77508 18.7755 5.30694 18.918 5.83284 18.8488C6.07287 18.8172 6.31628 18.7185 6.65196 18.5411C7.14544 18.2803 7.73558 18.2699 8.21895 18.549C8.70227 18.8281 8.98827 19.3443 9.00912 19.902C9.02332 20.2815 9.05958 20.5417 9.15224 20.7654C9.35523 21.2554 9.74458 21.6448 10.2346 21.8478C10.6022 22 11.0681 22 12 22C12.9319 22 13.3978 22 13.7654 21.8478C14.2554 21.6448 14.6448 21.2554 14.8478 20.7654C14.9404 20.5417 14.9767 20.2815 14.9909 19.9021C15.0117 19.3443 15.2977 18.8281 15.7811 18.549C16.2644 18.27 16.8545 18.2804 17.3479 18.5412C17.6837 18.7186 17.9271 18.8173 18.1671 18.8489C18.693 18.9182 19.2249 18.7756 19.6457 18.4527C19.9613 18.2106 20.1943 17.807 20.6603 17C20.8677 16.6407 21.029 16.3614 21.1486 16.1272M20.3387 13.3608C19.8662 13.0639 19.5622 12.5581 19.5621 12.0001C19.5621 11.442 19.8662 10.9361 20.3387 10.6392C20.6603 10.4372 20.8674 10.2757 21.0148 10.0836C21.3377 9.66278 21.4802 9.13092 21.411 8.60502C21.3591 8.2106 21.1261 7.80708 20.6601 7.00005C20.1942 6.19301 19.9612 5.7895 19.6456 5.54732C19.2248 5.22441 18.6929 5.0819 18.167 5.15113C17.927 5.18274 17.6836 5.2814 17.3479 5.45883C16.8544 5.71964 16.2643 5.73004 15.781 5.45096C15.2977 5.1719 15.0117 4.6557 14.9909 4.09803C14.9767 3.71852 14.9404 3.45835 14.8478 3.23463C14.6448 2.74458 14.2554 2.35523 13.7654 2.15224C13.3978 2 12.9319 2 12 2C11.0681 2 10.6022 2 10.2346 2.15224C9.74458 2.35523 9.35523 2.74458 9.15224 3.23463C9.05958 3.45833 9.02332 3.71848 9.00912 4.09794C8.98826 4.65566 8.70225 5.17191 8.21891 5.45096C7.73557 5.73002 7.14548 5.71959 6.65205 5.4588C6.31633 5.28136 6.0729 5.18269 5.83285 5.15108C5.30695 5.08185 4.77509 5.22436 4.35427 5.54727C4.03866 5.78945 3.80569 6.19297 3.33974 7C3.13231 7.35929 2.97105 7.63859 2.85138 7.87273" stroke="currentColor" stroke-width="1.9" stroke-linecap="round"></path> </g></svg>
        </button>
        <button class="icon-btn" id="themeBtn" title="切换主题" aria-label="切换主题">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="5"/>
            <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
          </svg>
        </button>

        <button class="icon-btn" id="addBtn" title="添加" aria-label="添加验证码">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
          </svg>
        </button>
      </div>
    </header>

    <!-- 搜索栏 -->
    <div class="toolbar">
      <input type="search" id="searchInput" class="search" placeholder="搜索...">
      <div class="filter-tags" id="filterTags"></div>
      <select id="sortSelect" class="sort-select">
        <option value="default">默认排序</option>
        <option value="name">按名称</option>
        <option value="recent">最近使用</option>
      </select>
    </div>

    <!-- 主内容区 -->
    <main class="main">
      <!-- 首页视图 - 双栏验证码卡片 -->
      <div id="homeView" class="view active">
        <div class="code-grid" id="codeGrid"></div>
        <div class="empty-state" id="emptyState">
          <div class="empty-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
              <path d="M7 11V7a5 5 0 0110 0v4"/>
            </svg>
          </div>
          <p>暂无验证码</p>
          <button class="btn-primary" id="addFirstBtn">添加第一个</button>
        </div>
      </div>

      <!-- 管理视图 - 列表 -->
      <div id="manageView" class="view">
        <div class="manage-list" id="manageList"></div>
      </div>

      <!-- 迁移视图 -->
      <div id="migrationView" class="view">
        <div class="migration-layout">
          <section class="migration-card migration-workspace">
            <div class="migration-header">
              <div class="migration-header-main">
                <h2>迁移工具</h2>
                <p class="migration-card-desc">导入或导出 otpauth-migration 数据。</p>
              </div>
              <div class="migration-meta">
                <span class="migration-badge" id="migrationCountBadge">当前条目 0</span>
                <span class="migration-badge muted">仅本地处理，不上传网络</span>
              </div>
            </div>

            <div class="migration-tabs" role="tablist" aria-label="迁移功能分页">
              <button type="button" class="migration-tab active" data-migration-tab="import" aria-selected="true">导入</button>
              <button type="button" class="migration-tab" data-migration-tab="export" aria-selected="false">导出</button>
            </div>

            <div class="migration-pane active" data-migration-pane="import">
              <div class="migration-stepper">
                <div class="migration-step-indicator active" data-step-marker="1">1. 输入来源</div>
                <div class="migration-step-indicator" data-step-marker="2">2. 预览导入</div>
                <div class="migration-step-indicator" data-step-marker="3">3. 完成</div>
              </div>

              <div class="migration-step active" data-step="1">
                <h3>Step 1: 输入迁移数据</h3>
                <p class="migration-card-desc">支持 otpauth://、otpauth-migration://offline?data=... 或直接粘贴 migration payload。</p>
                <div class="migration-actions">
                  <button type="button" class="btn-muted migration-btn" id="migrationPasteQuickBtn">从剪贴板粘贴文本</button>
                  <button type="button" class="btn-muted migration-btn" id="migrationQrFileBtn">上传二维码图片</button>
                  <input type="file" id="migrationQrFileInput" accept="image/*" hidden>
                </div>
                <div class="migration-paste-box" id="migrationPasteBox" tabindex="0">
                  <p>支持 <kbd>Ctrl</kbd> + <kbd>V</kbd> 粘贴二维码图片</p>
                  <span>识别成功后会自动进入下一步预览。</span>
                </div>
                <textarea id="migrationInput" class="migration-textarea" rows="6" placeholder="otpauth://totp/Google:alice@example.com?...&#10;otpauth-migration://offline?data=..."></textarea>
                <div class="migration-step-actions">
                  <button type="button" class="btn-muted migration-btn" id="migrationClearBtn">清空</button>
                  <button type="button" class="btn-primary migration-btn" id="migrationParseBtn">解析并继续</button>
                </div>
              </div>

              <div class="migration-step" data-step="2">
                <h3>Step 2: 预览并导入</h3>
                <p id="migrationPreviewSummary" class="migration-card-desc">暂无待导入条目。</p>
                <div class="migration-preview-list" id="migrationPreviewList"></div>
                <label class="form-label migration-field">
                  <span>检测到同名同发行方条目时</span>
                  <select id="migrationConflictSelect">
                    <option value="skip">跳过已有条目（推荐）</option>
                    <option value="replace">覆盖已有条目</option>
                    <option value="duplicate">保留并创建副本</option>
                  </select>
                </label>
                <div class="migration-step-actions">
                  <button type="button" class="btn-muted migration-btn" id="migrationBackBtn">返回修改输入</button>
                  <button type="button" class="btn-primary migration-btn" id="migrationApplyBtn">确认导入</button>
                </div>
              </div>

              <div class="migration-step" data-step="3">
                <h3>Step 3: 导入完成</h3>
                <p id="migrationLandingSummary" class="migration-card-desc">导入完成。</p>
                <div class="migration-preview-list" id="migrationLandingDetails"></div>
                <div class="migration-step-actions">
                  <button type="button" class="btn-muted migration-btn" id="migrationRestartBtn">继续导入</button>
                  <button type="button" class="btn-primary migration-btn" id="migrationGoHomeBtn">回到首页</button>
                </div>
              </div>
            </div>

            <div class="migration-pane" data-migration-pane="export">
              <div class="migration-export-head">
                <div>
                  <h3>导出为 otpauth-migration</h3>
                  <p class="migration-card-desc">可复制迁移字符串，或生成二维码进行跨设备导入。</p>
                </div>
                <div class="migration-export-tools">
                  <button type="button" class="migration-icon-btn" id="migrationExportRefreshBtn" title="刷新导出内容" aria-label="刷新导出内容">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M21 12a9 9 0 10-2.64 6.36"></path>
                      <polyline points="21 3 21 9 15 9"></polyline>
                    </svg>
                  </button>
                  <button type="button" class="migration-icon-btn" id="migrationExportCopyTextBtn" title="复制迁移字符串" aria-label="复制迁移字符串">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <rect x="9" y="9" width="13" height="13" rx="2"></rect>
                      <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                    </svg>
                  </button>
                  <button type="button" class="migration-icon-btn" id="migrationExportCopyQrBtn" title="复制二维码图片" aria-label="复制二维码图片">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect>
                      <rect x="3" y="14" width="7" height="7"></rect><path d="M14 14h3v3h-3zM20 14h1v1h-1zM18 18h3v3h-3z"></path>
                    </svg>
                  </button>
                  <button type="button" class="migration-icon-btn" id="migrationExportSaveQrBtn" title="保存二维码图片" aria-label="保存二维码图片">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                      <polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                  </button>
                </div>
              </div>
              <textarea id="migrationExportOutput" class="migration-textarea migration-export-output" rows="6" readonly placeholder="点击刷新按钮生成 migration 字符串"></textarea>
              <div class="migration-qr-section">
                <div class="migration-qr-wrap" id="migrationExportQrWrap">
                  <img id="migrationExportQrImage" alt="migration 二维码">
                </div>
                <p class="migration-card-desc">二维码默认包含当前全部可导出条目。</p>
              </div>
            </div>
          </section>
        </div>
      </div>

      <!-- 设置视图 -->
      <div id="settingsView" class="view">
        <div class="settings-layout">
          <section class="settings-card">
            <h2>数据与备份</h2>
            <p class="migration-card-desc" id="settingsDataSummary">用于导出与导入数据。</p>
            <div class="settings-list">
              <div class="settings-item">
                <div class="settings-item-info">
                  <div class="settings-item-title">导出数据</div>
                  <div class="settings-item-desc">支持 otpauth-migration、JSON、TXT、专用备份格式。</div>
                </div>
                <div class="settings-item-controls">
                  <select id="settingsExportFormat" class="sort-select">
                    <option value="migration">otpauth-migration 链接</option>
                    <option value="json">JSON</option>
                    <option value="txt">TXT（每行一个 otpauth）</option>
                    <option value="backup">专用备份文件（全量）</option>
                  </select>
                  <button type="button" class="btn-primary" id="settingsExportBtn">导出文件</button>
                </div>
              </div>
              <div class="settings-item">
                <div class="settings-item-info">
                  <div class="settings-item-title">导入数据</div>
                  <div class="settings-item-desc">仅支持专用备份文件，全量覆盖当前数据。</div>
                </div>
                <div class="settings-item-controls">
                  <button type="button" class="btn-danger" id="settingsImportBtn">导入备份文件</button>
                  <input type="file" id="settingsImportInput" accept=".g2fabak,.backup,.txt" hidden>
                </div>
              </div>
            </div>
            <footer class="settings-footer">
              <span id="settingsVersionText">Version: -</span>
              <span id="settingsAuthorText">Author: -</span>
              <a id="settingsGithubLink" href="#" target="_blank" rel="noopener">GitHub</a>
            </footer>
          </section>
        </div>
      </div>
    </main>

    <!-- 导入/添加弹窗 -->
    <dialog id="addDialog" class="dialog" aria-labelledby="dialogTitle">
      <form class="dialog-content" id="addForm">
        <div class="dialog-header">
          <h3 id="dialogTitle">添加验证码</h3>
          <button type="button" class="close-btn" id="closeDialog" aria-label="关闭添加弹窗">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
          </button>
        </div>

        <!-- 剪贴板检测提示 -->
        <div class="clipboard-hint" id="clipboardHint" style="display:none">
          <span>检测到剪贴板中有验证码链接</span>
          <button type="button" class="btn-hint" id="applyClipboardBtn">导入到表单</button>
        </div>

        <!-- 简单模式：只需名字和密钥 -->
        <div class="form-basic">
          <label class="form-label">
            <span>名称</span>
            <input type="text" id="nameInput" placeholder="例如：GitHub" required>
          </label>
          <label class="form-label">
            <span>发行方</span>
            <input type="text" id="issuerInput" placeholder="可选，例如：Google">
          </label>
          <label class="form-label">
            <span>密钥</span>
            <div class="input-with-paste">
              <textarea id="secretInput" rows="3" placeholder="粘贴密钥或 otpauth:// 链接" required></textarea>
              <button type="button" class="paste-btn" id="pasteBtn" title="从剪贴板粘贴" aria-label="从剪贴板粘贴">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M16 4h2a2 2 0 012 2v14a2 2 0 01-2 2H6a2 2 0 01-2-2V6a2 2 0 012-2h2"/>
                  <rect x="8" y="2" width="8" height="4" rx="1" ry="1"/>
                </svg>
              </button>
            </div>
          </label>
        </div>

        <!-- 高级选项 -->
        <details class="advanced">
          <summary>高级选项</summary>
          <div class="form-advanced">
            <div class="tag-editor">
              <span class="advanced-label">标签</span>
              <div class="tag-input-row">
                <input type="text" id="tagInput" placeholder="输入标签后回车">
                <button type="button" class="btn-tag-add" id="addTagBtn">添加</button>
              </div>
              <div class="tag-suggestions" id="tagSuggestions"></div>
              <div class="tag-selected" id="selectedTags"></div>
            </div>

            <div class="status-options">
              <label class="checkbox-label">
                <input type="checkbox" id="pinnedInput">
                <span>置顶</span>
              </label>
              <label class="checkbox-label">
                <input type="checkbox" id="deprecatedInput">
                <span>弃用（首页隐藏）</span>
              </label>
            </div>

            <div class="form-row">
              <label class="form-label">
                <span>算法</span>
                <select id="algorithmInput">
                  <option value="SHA1" selected>SHA1</option>
                  <option value="SHA256">SHA256</option>
                  <option value="SHA512">SHA512</option>
                </select>
              </label>
              <label class="form-label">
                <span>位数</span>
                <select id="digitsInput">
                  <option value="6" selected>6</option>
                  <option value="7">7</option>
                  <option value="8">8</option>
                </select>
              </label>
            </div>
            <div class="form-row">
              <label class="form-label">
                <span>类型</span>
                <select id="otpTypeInput">
                  <option value="totp" selected>TOTP</option>
                  <option value="hotp">HOTP</option>
                </select>
              </label>
              <label class="form-label">
                <span>周期（秒）</span>
                <input type="number" id="periodInput" value="30" min="10" max="120">
              </label>
            </div>
            <label class="form-label" id="counterLabel" style="display:none">
              <span>计数器（HOTP）</span>
              <input type="number" id="counterInput" value="0" min="0">
            </label>
          </div>
        </details>

        <div class="dialog-actions">
          <button type="button" class="btn-danger" id="deleteBtn" style="display:none">删除</button>
          <button type="submit" class="btn-primary">保存</button>
        </div>
      </form>
    </dialog>

    <!-- 导入菜单弹窗 -->
    <dialog id="importMenuDialog" class="dialog" aria-labelledby="importMenuTitle">
      <div class="dialog-content">
        <div class="dialog-header">
          <h3 id="importMenuTitle">导入</h3>
          <button type="button" class="close-btn" id="closeImportMenu" aria-label="关闭导入弹窗">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
          </button>
        </div>
        <div class="import-menu">
          <button class="import-option" id="importQrBtn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/>
              <rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/>
            </svg>
            <span>扫描屏幕二维码</span>
          </button>
          <label class="import-option">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
              <circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/>
            </svg>
            <span>从图片识别二维码</span>
            <input type="file" id="qrFileInput" accept="image/*" hidden>
          </label>
          <button class="import-option" id="importOtpauthBtn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"/>
              <path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"/>
            </svg>
            <span>粘贴 otpauth:// 链接</span>
          </button>
          <button class="import-option" id="importMigrationBtn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
              <polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/>
              <line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/>
            </svg>
            <span>粘贴迁移链接（多账号）</span>
          </button>
        </div>
      </div>
    </dialog>

    <!-- 删除确认弹窗 -->
    <dialog id="deleteConfirmDialog" class="dialog confirm-dialog" aria-labelledby="deleteConfirmTitle">
      <div class="dialog-content confirm-dialog-content">
        <h3 id="deleteConfirmTitle">确认删除</h3>
        <p id="deleteConfirmMessage" class="confirm-dialog-message">确定删除该条目吗？删除后不可恢复。</p>
        <div class="dialog-actions confirm-dialog-actions">
          <button type="button" class="btn-muted" id="cancelDeleteBtn">取消</button>
          <button type="button" class="btn-danger" id="confirmDeleteBtn">删除</button>
        </div>
      </div>
    </dialog>

    <!-- Toast 提示 -->
    <dialog id="toast" class="toast" aria-live="polite"></dialog>
  </div>

  <script src="vendor/jsQR.js"></script>
  <script src="vendor/qrcode.min.js"></script>
  <script src="index.js"></script>
</body>
</html>
